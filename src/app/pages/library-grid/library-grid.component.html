<!-- src/app/pages/library-grid/library-grid.component.html -->
<style>
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
</style>

<div class="library-grid-container">
  <div class="header">
    <div>
      <h2>ğŸ“š Suraksha Library - Seat Management</h2>
      <!-- <p class="subtitle" *ngIf="authService.canEdit()">Click empty seats to register new students | Click occupied seats to view profiles</p> 
      <p class="subtitle" *ngIf="!authService.canEdit()">Viewing library seat occupancy and student attendance</p>-->
    </div>
    
    <!-- Statistics Summary -->
    <div class="stats-summary">
      <div class="stat-card">
        <div class="stat-icon">ğŸª‘</div>
        <div class="stat-content">
          <div class="stat-label">Free Full Day</div>
          <div class="stat-value">{{ getFreeFullDaySeatsCount() }}</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">âœ…</div>
        <div class="stat-content">
          <div class="stat-label">Occupied Full Day</div>
          <div class="stat-value">{{ getOccupiedFullDaySeatsCount() }}</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">â°</div>
        <div class="stat-content">
          <div class="stat-label">Free Half Day</div>
          <div class="stat-value">{{ getFreeHalfDaySeatsCount() }}</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">â±ï¸</div>
        <div class="stat-content">
          <div class="stat-label">Occupied Half Day</div>
          <div class="stat-value">{{ getOccupiedHalfDaySeatsCount() }}</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ‘¨</div>
        <div class="stat-content">
          <div class="stat-label">Total Boys</div>
          <div class="stat-value">{{ getTotalMalesCount() }}</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ‘©</div>
        <div class="stat-content">
          <div class="stat-label">Total Girls</div>
          <div class="stat-value">{{ getTotalFemalesCount() }}</div>
        </div>
      </div>
    </div>
    
    <div class="header-actions">
      <button (click)="openMyAttendanceModal()" class="btn btn-primary">
        ğŸ“ Mark My Attendance
      </button>
      <button routerLink="/resources" class="btn btn-info">
        ğŸ“š Library Resources
      </button>
      <button (click)="loadSeats()" class="btn-refresh">ğŸ”„ Refresh</button>
      <button *ngIf="isAdmin()" (click)="toggleBulkOperations()" class="btn-bulk">
        ğŸ“‹ Bulk Operations
      </button>
    </div>
  </div>

  <!-- Bulk Operations Panel (Admin Only) -->
  <div *ngIf="showBulkOperations && isAdmin()" class="bulk-operations-panel">
    <div class="bulk-header">
      <h3>ğŸ“‹ Bulk Operations</h3>
      <button (click)="toggleBulkMode()" [class.active]="bulkMode" class="btn btn-secondary">
        {{ bulkMode ? 'âœ“ Selection Mode Active' : 'Enable Selection Mode' }}
      </button>
    </div>

    <div *ngIf="bulkMode" class="bulk-controls">
      <div class="selection-info">
        <strong>{{ selectedSeats.length }} seats selected</strong>
      </div>

      <div class="bulk-actions">
        <button (click)="selectAllOccupiedSeats()" class="btn btn-info btn-sm">
          Select All Occupied
        </button>
        <button (click)="selectAllEmptySeats()" class="btn btn-info btn-sm">
          Select All Empty
        </button>
        <button (click)="clearSelection()" class="btn btn-secondary btn-sm">
          Clear Selection
        </button>
      </div>

      <div class="bulk-execute" *ngIf="selectedSeats.length > 0">
        <button (click)="executeBulkRelease()" [disabled]="saving" class="btn btn-danger">
          ğŸšª Release {{ selectedSeats.length }} Seats
        </button>
        <button (click)="sendBulkWhatsAppMessages()" class="btn btn-success">
          ğŸ“± Send WhatsApp to All
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="alert alert-error">{{ errorMessage }}</div>

  <div *ngIf="loading" class="loading">Loading seats...</div>

  <!-- 6x6 Seat Grid -->
  <div *ngIf="!loading" class="seat-grid">
    <div *ngFor="let seat of seats" 
         class="seat-box" 
         [ngClass]="[
           getSeatClass(seat), 
           !authService.canEdit() ? 'no-click' : '',
           bulkMode && isSeatSelected(seat.seat_no) ? 'selected' : ''
         ]"
         [title]="getSeatTooltip(seat)"
         [matBadge]="getSeatBadge(seat).value"
         [matBadgeColor]="getSeatBadge(seat).color"
         matBadgeSize="medium"
         matBadgePosition="above after"
         [matBadgeHidden]="getSeatBadge(seat).hidden"
         (click)="bulkMode ? toggleSeatSelection(seat.seat_no) : onSeatClick(seat)">
      
      <!-- Bulk Selection Checkbox -->
      <div *ngIf="bulkMode" class="bulk-checkbox" (click)="$event.stopPropagation(); toggleSeatSelection(seat.seat_no)">
        <input type="checkbox" [checked]="isSeatSelected(seat.seat_no)" (click)="$event.stopPropagation()">
      </div>

      <!-- FREE SEAT -->
      <ng-container *ngIf="!seat.full_time_student_id && !seat.first_half_student_id && !seat.second_half_student_id">
        <div class="seat-status-top">Free</div>
        <div class="seat-number">{{ seat.seat_no }}</div>
      </ng-container>
      
      <!-- FULL TIME STUDENT -->
      <ng-container *ngIf="seat.full_time_student_id">
        <div class="seat-status-top">Full Time</div>
        <div class="seat-number">{{ seat.seat_no }}</div>
        <div class="student-name">{{ getFullTimeStudentDisplay(seat) }}</div>
      </ng-container>
      
      <!-- BOTH SHIFTS OCCUPIED -->
      <ng-container *ngIf="seat.first_half_student_id && seat.second_half_student_id">
        <div class="seat-status-top">Full Day</div>
        <div class="seat-number">{{ seat.seat_no }}</div>
        <div class="dual-students">
          <div class="half-shift">
            <div class="shift-label">ğŸŒ… 1st</div>
            <div class="student-name">{{ getFirstHalfStudentDisplay(seat) }}</div>
          </div>
          <div class="half-shift">
            <div class="shift-label">ğŸŒƒ 2nd</div>
            <div class="student-name">{{ getSecondHalfStudentDisplay(seat) }}</div>
          </div>
        </div>
      </ng-container>
      
      <!-- FIRST HALF ONLY -->
      <ng-container *ngIf="seat.first_half_student_id && !seat.second_half_student_id">
        <div class="seat-status-top">First Half</div>
        <div class="seat-number">{{ seat.seat_no }}</div>
        <div class="student-name">{{ getFirstHalfStudentDisplay(seat) }}</div>
      </ng-container>
      
      <!-- SECOND HALF ONLY -->
      <ng-container *ngIf="seat.second_half_student_id && !seat.first_half_student_id">
        <div class="seat-status-top">Second Half</div>
        <div class="seat-number">{{ seat.seat_no }}</div>
        <div class="student-name">{{ getSecondHalfStudentDisplay(seat) }}</div>
      </ng-container>
    </div>
  </div>

  <!-- Student Profile Modal -->
  <div class="modal-overlay" *ngIf="showProfileModal" (click)="closeModal()">
    <div class="modal-content" [class.wide-modal]="showBothStudents" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ğŸ‘¨â€ğŸ“ Student Profile{{ showBothStudents ? 's' : '' }}</h3>
        <button (click)="closeModal()" class="close-btn">&times;</button>
      </div>
      
      <!-- Single Student View -->
      <div class="modal-body" *ngIf="selectedStudent && !showBothStudents">
        <div class="profile-layout-3col">
          <div class="profile-photo-col">
            <img *ngIf="selectedStudent.photo_url" [src]="selectedStudent.photo_url" alt="Student Photo">
            <div *ngIf="!selectedStudent.photo_url" class="no-photo">ğŸ“·</div>
          </div>
          <div class="profile-info-col">
            <h4>{{ selectedStudent.name }}</h4>
            
            <!-- Personal Details - Only for Admin and Library Manager -->
            <div *ngIf="canViewPersonalDetails()">
              <p><strong>Mobile:</strong> {{ selectedStudent.mobile }}</p>
              <p><strong>Address:</strong> {{ selectedStudent.address }}</p>
              <p><strong>Emergency:</strong> {{ selectedStudent.emergency_contact_name || 'N/A' }} - {{ selectedStudent.emergency_contact }}</p>
            </div>
            
            <!-- Limited info for viewers -->
            <div *ngIf="!canViewPersonalDetails()">
              <p class="text-muted"><em>Personal details hidden</em></p>
            </div>
            
            <p><strong>Seat:</strong> {{ selectedSeat?.seat_no }}</p>
            <p><strong>Joined:</strong> {{ selectedStudent.joining_date }}</p>
            <p><strong>Status:</strong> <span [class]="'badge badge-' + selectedStudent.status">{{ selectedStudent.status }}</span></p>
          </div>
          <div class="profile-actions-col">
            <button (click)="toggleAttendance(selectedStudent)" 
                    [class]="'btn btn-compact ' + getAttendanceButtonClass()"
                    [disabled]="isAttendanceButtonDisabled()">
              {{ getAttendanceButtonText() }}
            </button>
            <button *ngIf="authService.canEdit()" 
                    (click)="openFeePaymentModal(selectedStudent)" 
                    class="btn btn-compact btn-success">
              ğŸ’³ Pay Fee
            </button>
            <button *ngIf="authService.canEdit() && selectedStudent"
                    (click)="openChangeSeatModal(selectedStudent, getCurrentShiftType())"
                    class="btn btn-compact btn-info">
              ğŸ”„ Change Seat
            </button>
            <button (click)="sendWhatsAppReminder()" class="btn btn-compact btn-success">
              ğŸ’¬ Reminder
            </button>
            <button (click)="sendEmergencySOS()" class="btn btn-compact btn-warning">
              ğŸš¨ SOS
            </button>
            <button (click)="releaseSeatConfirm()" class="btn btn-compact btn-danger">
              ğŸšª Release
            </button>
            <button *ngIf="isOtherShiftAvailable() && authService.canEdit()" 
                    (click)="addStudentForOtherShift()" 
                    class="btn btn-compact btn-primary">
              â• Add {{ getAvailableShiftName() }}
            </button>
          </div>
        </div>
      </div>

      <!-- Both Students View (Side by Side) -->
      <div class="modal-body dual-students" *ngIf="showBothStudents">
        <!-- First Half Student -->
        <div class="student-card" *ngIf="selectedStudent">
          <div class="shift-badge morning">ğŸŒ… Morning</div>
          <div class="profile-layout-3col">
            <div class="profile-photo-col">
              <img *ngIf="selectedStudent.photo_url" [src]="selectedStudent.photo_url" alt="Student Photo">
              <div *ngIf="!selectedStudent.photo_url" class="no-photo">ğŸ“·</div>
            </div>
            <div class="profile-info-col">
              <h4>{{ selectedStudent.name }}</h4>
              
              <!-- Personal Details - Only for Admin and Library Manager -->
              <div *ngIf="canViewPersonalDetails()">
                <p><strong>Mobile:</strong> {{ selectedStudent.mobile }}</p>
                <p><strong>Address:</strong> {{ selectedStudent.address }}</p>
                <p><strong>Emergency:</strong> {{ selectedStudent.emergency_contact_name || 'N/A' }} - {{ selectedStudent.emergency_contact }}</p>
              </div>
              
              <!-- Limited info for viewers -->
              <div *ngIf="!canViewPersonalDetails()">
                <p class="text-muted"><em>Hidden</em></p>
              </div>
              
              <p><strong>Seat:</strong> {{ selectedSeat?.seat_no }}</p>
              <p><strong>Joined:</strong> {{ selectedStudent.joining_date }}</p>
              <p><strong>Expiry:</strong> {{ selectedSeat?.first_half_expiry }}</p>
              <p><strong>Status:</strong> <span [class]="'badge badge-' + selectedStudent.status">{{ selectedStudent.status }}</span></p>
            </div>
            <div class="profile-actions-col">
              <button (click)="toggleAttendance(selectedStudent)" 
                      [class]="'btn btn-compact ' + getAttendanceButtonClassForStudent(selectedStudent.id)"
                      [disabled]="isAttendanceButtonDisabledForStudent(selectedStudent.id)">
                {{ getAttendanceButtonTextForStudent(selectedStudent.id) }}
              </button>
              <button *ngIf="authService.canEdit()" 
                      (click)="openFeePaymentModal(selectedStudent)" 
                      class="btn btn-compact btn-success">
                ğŸ’³ Fee
              </button>
              <button *ngIf="authService.canEdit()"
                      (click)="openChangeSeatModal(selectedStudent, 'first_half')" 
                      class="btn btn-compact btn-info">
                ğŸ”„ Change
              </button>
              <button (click)="sendWhatsAppReminder(selectedStudent)" class="btn btn-compact btn-success">
                ğŸ’¬ Reminder
              </button>
              <button (click)="sendEmergencySOS(selectedStudent)" class="btn btn-compact btn-warning">
                ğŸš¨ SOS
              </button>
              <button (click)="releaseSeatConfirm(selectedStudent, 'first_half')" class="btn btn-compact btn-danger">
                ğŸšª Release
              </button>
            </div>
          </div>
        </div>

        <!-- Second Half Student -->
        <div class="student-card" *ngIf="selectedSecondStudent">
          <div class="shift-badge evening">ğŸŒƒ Evening</div>
          <div class="profile-layout-3col">
            <div class="profile-photo-col">
              <img *ngIf="selectedSecondStudent.photo_url" [src]="selectedSecondStudent.photo_url" alt="Student Photo">
              <div *ngIf="!selectedSecondStudent.photo_url" class="no-photo">ğŸ“·</div>
            </div>
            <div class="profile-info-col">
              <h4>{{ selectedSecondStudent.name }}</h4>
              
              <!-- Personal Details - Only for Admin and Library Manager -->
              <div *ngIf="canViewPersonalDetails()">
                <p><strong>Mobile:</strong> {{ selectedSecondStudent.mobile }}</p>
                <p><strong>Address:</strong> {{ selectedSecondStudent.address }}</p>
                <p><strong>Emergency:</strong> {{ selectedSecondStudent.emergency_contact_name || 'N/A' }} - {{ selectedSecondStudent.emergency_contact }}</p>
              </div>
              
              <!-- Limited info for viewers -->
              <div *ngIf="!canViewPersonalDetails()">
                <p class="text-muted"><em>Hidden</em></p>
              </div>
              
              <p><strong>Seat:</strong> {{ selectedSeat?.seat_no }}</p>
              <p><strong>Joined:</strong> {{ selectedSecondStudent.joining_date }}</p>
              <p><strong>Expiry:</strong> {{ selectedSeat?.second_half_expiry }}</p>
              <p><strong>Status:</strong> <span [class]="'badge badge-' + selectedSecondStudent.status">{{ selectedSecondStudent.status }}</span></p>
            </div>
            <div class="profile-actions-col">
              <button (click)="toggleAttendance(selectedSecondStudent)" 
                      [class]="'btn btn-compact ' + getAttendanceButtonClassForStudent(selectedSecondStudent.id)"
                      [disabled]="isAttendanceButtonDisabledForStudent(selectedSecondStudent.id)">
                {{ getAttendanceButtonTextForStudent(selectedSecondStudent.id) }}
              </button>
              <button *ngIf="authService.canEdit()" 
                      (click)="openFeePaymentModal(selectedSecondStudent)" 
                      class="btn btn-compact btn-success">
                ğŸ’³ Fee
              </button>
              <button *ngIf="authService.canEdit()"
                      (click)="openChangeSeatModal(selectedSecondStudent, 'second_half')" 
                      class="btn btn-compact btn-info">
                ğŸ”„ Change
              </button>
              <button (click)="sendWhatsAppReminder(selectedSecondStudent)" class="btn btn-compact btn-success">
                ğŸ’¬ Reminder
              </button>
              <button (click)="sendEmergencySOS(selectedSecondStudent)" class="btn btn-compact btn-warning">
                ğŸš¨ SOS
              </button>
              <button (click)="releaseSeatConfirm(selectedSecondStudent, 'second_half')" class="btn btn-compact btn-danger">
                ğŸšª Release
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Change Seat Modal -->
  <div class="modal-overlay" *ngIf="showChangeSeatModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ğŸ”„ Change Seat</h3>
        <button (click)="closeModal()" class="close-btn">&times;</button>
      </div>
      <div class="modal-body" *ngIf="changingSeatStudent">
        <div class="change-seat-info">
          <h4>{{ changingSeatStudent.name }}</h4>
          <p><strong>Current Seat:</strong> {{ selectedSeat?.seat_no }}</p>
          <p><strong>Shift Type:</strong> 
            <span *ngIf="changingSeatShiftType === 'full_time'">Full Time</span>
            <span *ngIf="changingSeatShiftType === 'first_half'">ğŸŒ… Morning Shift</span>
            <span *ngIf="changingSeatShiftType === 'second_half'">ğŸŒƒ Evening Shift</span>
          </p>
        </div>

        <div class="form-group">
          <label>Select New Seat *</label>
          <div class="available-seats-grid">
            <div *ngFor="let seat of availableSeatsForTransfer"
                 class="seat-option"
                 [class.selected]="newSeatNumber === seat.seat_no"
                 (click)="newSeatNumber = seat.seat_no">
              <div class="seat-option-number">{{ seat.seat_no }}</div>
              <div class="seat-option-status">Available</div>
            </div>
          </div>
          <p class="text-muted" *ngIf="availableSeatsForTransfer.length === 0">
            No available seats for this shift type
          </p>
        </div>

        <div class="modal-actions">
          <button (click)="closeModal()" class="btn btn-secondary">Cancel</button>
          <button (click)="confirmChangeSeat()" 
                  class="btn btn-primary"
                  [disabled]="!newSeatNumber || saving">
            {{ saving ? 'Changing...' : 'Confirm Change' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Fee Payment Modal -->
  <div class="modal-overlay" *ngIf="showFeePaymentModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ğŸ’³ Pay Fee - {{ selectedStudent?.name }}</h3>
        <button (click)="closeModal()" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Amount (â‚¹) <span class="required">*</span></label>
          <input type="number" [(ngModel)]="additionalFeePayment.amount_paid" class="form-control" min="1">
        </div>

        <div class="form-group">
          <label>Days <span class="required">*</span></label>
          <select [(ngModel)]="additionalFeePayment.days" class="form-control">
            <option [value]="7">1 Week</option>
            <option [value]="15">15 Days</option>
            <option [value]="30" selected>1 Month (30 days)</option>
            <option [value]="60">2 Months (60 days)</option>
            <option [value]="90">3 Months (90 days)</option>
            <option [value]="180">6 Months (180 days)</option>
          </select>
          <small class="text-muted">Subscription will be extended by {{ additionalFeePayment.days }} days</small>
        </div>

        <div class="form-group">
          <label>Payment Mode <span class="required">*</span></label>
          <select [(ngModel)]="additionalFeePayment.payment_mode" class="form-control">
            <option value="cash">ğŸ’µ Cash</option>
            <option value="upi">ğŸ“± UPI</option>
            <option value="card">ğŸ’³ Card</option>
          </select>
        </div>

        <div class="form-group" *ngIf="additionalFeePayment.payment_mode !== 'cash'">
          <label>Transaction Reference</label>
          <input type="text" [(ngModel)]="additionalFeePayment.transaction_reference" class="form-control" placeholder="Transaction ID / Reference Number">
        </div>

        <div class="alert alert-info">
          <strong>Note:</strong> This will extend the current subscription by {{ additionalFeePayment.days }} days.
        </div>
      </div>
      <div class="modal-footer">
        <button (click)="closeModal()" class="btn btn-secondary">Cancel</button>
        <button (click)="submitFeePayment()" [disabled]="saving" class="btn btn-success">
          {{ saving ? 'Processing...' : 'ğŸ’³ Pay â‚¹' + additionalFeePayment.amount_paid }}
        </button>
      </div>
    </div>
  </div>

  <!-- Receipt Modal -->
  <div class="modal-overlay" *ngIf="showReceiptModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ğŸ§¾ Payment Receipt</h3>
        <button (click)="closeModal()" class="close-btn">&times;</button>
      </div>
      <div class="modal-body" *ngIf="receiptData">
        <div class="receipt-container">
          <div class="receipt-header">
            <h2>ğŸ“š Suraksha Library</h2>
            <p>Fee Payment Receipt</p>
            <p class="receipt-number">Receipt No: {{ receiptData.receipt_no }}</p>
          </div>

          <div class="receipt-details">
            <div class="receipt-row">
              <span class="label">Date:</span>
              <span class="value">{{ receiptData.date }}</span>
            </div>
            <div class="receipt-row">
              <span class="label">Student Name:</span>
              <span class="value">{{ receiptData.student_name }}</span>
            </div>
            <div class="receipt-row">
              <span class="label">Mobile:</span>
              <span class="value">{{ receiptData.mobile }}</span>
            </div>
            <div class="receipt-row">
              <span class="label">Seat Number:</span>
              <span class="value">{{ receiptData.seat_no }}</span>
            </div>
            <div class="receipt-row">
              <span class="label">Shift Type:</span>
              <span class="value">{{ receiptData.shift_type.replace('_', ' ') | titlecase }}</span>
            </div>
            <div class="receipt-row">
              <span class="label">Payment Mode:</span>
              <span class="value">{{ receiptData.payment_mode | uppercase }}</span>
            </div>
            <div class="receipt-row">
              <span class="label">Transaction Ref:</span>
              <span class="value">{{ receiptData.transaction_ref }}</span>
            </div>
            <div class="receipt-row">
              <span class="label">Valid From:</span>
              <span class="value">{{ receiptData.valid_from }}</span>
            </div>
            <div class="receipt-row">
              <span class="label">Valid Until:</span>
              <span class="value">{{ receiptData.valid_until }}</span>
            </div>
          </div>

          <div class="receipt-amount">
            <div class="amount-label">Amount Paid</div>
            <div class="amount-value">â‚¹{{ receiptData.amount_paid }}</div>
          </div>

          <div class="receipt-footer">
            <p>Thank you for your payment!</p>
            <p class="text-muted">Suraksha Library Management System</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button (click)="printReceipt()" class="btn btn-primary">
          ğŸ–¨ï¸ Print Receipt
        </button>
        <button (click)="shareReceiptOnWhatsApp()" class="btn btn-success">
          ğŸ“± Share on WhatsApp
        </button>
        <button (click)="closeModal()" class="btn btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <!-- Enhanced My Attendance Modal (Self-Marking) -->
  <div *ngIf="showMyAttendanceModal" class="modal-overlay" style="backdrop-filter: blur(10px);" (click)="closeMyAttendanceModal()">
    <div class="modal-content" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 24px; max-width: 500px; box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4); border: 1px solid rgba(255,255,255,0.2);" (click)="$event.stopPropagation()">
      <div class="modal-header" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 24px 24px 0 0; padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <div style="display: flex; align-items: center; gap: 16px;">
          <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
            <span style="font-size: 2rem;">ğŸ“</span>
            <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">Mark My Attendance</h3>
          </div>
          <button (click)="closeMyAttendanceModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">&times;</button>
        </div>
      </div>

      <div class="modal-body" style="padding: 32px 24px;">
        <div *ngIf="successMessage" class="alert alert-success" style="background: rgba(72, 187, 120, 0.2); border: 1px solid rgba(72, 187, 120, 0.3); color: #48bb78; margin-bottom: 20px;">{{ successMessage }}</div>
        <div *ngIf="errorMessage" class="alert alert-error" style="background: rgba(245, 101, 101, 0.2); border: 1px solid rgba(245, 101, 101, 0.3); color: #f56565; margin-bottom: 20px;">{{ errorMessage }}</div>

        <!-- Enhanced Search by Mobile -->
        <div *ngIf="!myAttendanceStudent" class="form-section">
          <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 24px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.2);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
              <span style="font-size: 1.5rem;">ğŸ“±</span>
              <div style="flex: 1;">
                <h4 style="margin: 0; font-size: 1.1rem; font-weight: 600;">Enter registered mobile number â€¢ Available 7:00 AM - 7:00 PM</h4>
              </div>
            </div>
            
            <div style="position: relative;">
              <input 
                type="tel" 
                [(ngModel)]="myAttendanceMobile"
                maxlength="10"
                placeholder="Enter your 10-digit mobile number"
                style="width: 100%; padding: 16px 20px 16px 50px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50px; background: rgba(255,255,255,0.9); color: #2d3748; font-size: 1rem; box-shadow: inset 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease;"
                [disabled]="searchingStudent"
                (input)="errorMessage = ''; successMessage = ''"
                onfocus="this.style.borderColor='rgba(255,255,255,0.6)'; this.style.boxShadow='0 0 0 3px rgba(255,255,255,0.2), inset 0 2px 8px rgba(0,0,0,0.1)'"
                onblur="this.style.borderColor='rgba(255,255,255,0.3)'; this.style.boxShadow='inset 0 2px 8px rgba(0,0,0,0.1)'">
              <span style="position: absolute; left: 18px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; color: #4a5568;">ğŸ“</span>
            </div>
          </div>

          <button 
            (click)="searchMyStudent()" 
            [disabled]="searchingStudent || myAttendanceMobile.length !== 10"
            style="width: 100%; padding: 16px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4); display: flex; align-items: center; justify-content: center; gap: 8px;"
            [style.opacity]="searchingStudent || myAttendanceMobile.length !== 10 ? '0.6' : '1'"
            [style.cursor]="searchingStudent || myAttendanceMobile.length !== 10 ? 'not-allowed' : 'pointer'"
            onmouseover="if(!this.disabled) this.style.transform='translateY(-2px)'; if(!this.disabled) this.style.boxShadow='0 6px 20px rgba(240, 147, 251, 0.5)'"
            onmouseout="if(!this.disabled) this.style.transform='translateY(0)'; if(!this.disabled) this.style.boxShadow='0 4px 15px rgba(240, 147, 251, 0.4)'">
            <span style="font-size: 1.2rem;">{{ searchingStudent ? 'â³' : 'ğŸ”' }}</span>
            {{ searchingStudent ? 'Searching...' : 'Find My Profile' }}
          </button>

          <!-- Emergency Reset Button (shows after 5 seconds of searching) -->
          <button 
            *ngIf="searchingStudent"
            (click)="forceResetAttendanceSearch()"
            style="width: 100%; margin-top: 12px; padding: 12px; background: rgba(245, 101, 101, 0.2); color: #f56565; border: 1px solid rgba(245, 101, 101, 0.3); border-radius: 50px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease;"
            onmouseover="this.style.background='rgba(245, 101, 101, 0.3)'"
            onmouseout="this.style.background='rgba(245, 101, 101, 0.2)'">
            âš ï¸ Reset Search (if stuck)
          </button>
        </div>

        <!-- Enhanced Student Found - Mark Attendance -->
        <div *ngIf="myAttendanceStudent" class="attendance-section">
          <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 24px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.2);">
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
              <div style="width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">ğŸ‘‹</div>
              <div style="flex: 1;">
                <h4 style="margin: 0; font-size: 1.3rem; font-weight: 700;">Welcome, {{ myAttendanceStudent.name }}!</h4>
                <div style="display: flex; align-items: center; gap: 16px; margin-top: 8px; font-size: 0.9rem; opacity: 0.9;">
                  <span>ğŸ“± {{ myAttendanceStudent.mobile }}</span>
                  <span class="badge badge-success" style="background: rgba(72, 187, 120, 0.2); color: #48bb78; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">{{ myAttendanceStudent.status }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Enhanced Current Attendance Status -->
          <div *ngIf="myAttendanceStatus" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.2);">
            <h5 style="margin: 0 0 12px 0; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 1.2rem;">ğŸ“Š</span>
              Today's Status
            </h5>
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="opacity: 0.8;">Check-in:</span>
                <span style="font-weight: 600;">{{ myAttendanceStatus.check_in_time }}</span>
                <span *ngIf="myAttendanceStatus.status === 'late'" style="background: rgba(237, 137, 54, 0.2); color: #ed8936; padding: 2px 6px; border-radius: 8px; font-size: 0.8rem;">â° Late</span>
                <span *ngIf="myAttendanceStatus.status === 'present'" style="background: rgba(72, 187, 120, 0.2); color: #48bb78; padding: 2px 6px; border-radius: 8px; font-size: 0.8rem;">âœ… On Time</span>
              </div>
              <div *ngIf="myAttendanceStatus.check_out_time" style="display: flex; align-items: center; gap: 8px;">
                <span style="opacity: 0.8;">Check-out:</span>
                <span style="font-weight: 600;">{{ myAttendanceStatus.check_out_time }}</span>
              </div>
            </div>
          </div>

          <!-- Enhanced Action Buttons -->
          <div style="display: flex; gap: 12px;">
            <button 
              (click)="markMyAttendance()"
              [disabled]="isMyAttendanceButtonDisabled()"
              [ngClass]="getMyAttendanceButtonClass()"
              style="flex: 1; padding: 16px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);"
              onmouseover="if(!this.disabled) this.style.transform='translateY(-2px)'; if(!this.disabled) this.style.boxShadow='0 6px 20px rgba(72, 187, 120, 0.5)'"
              onmouseout="if(!this.disabled) this.style.transform='translateY(0)'; if(!this.disabled) this.style.boxShadow='0 4px 15px rgba(72, 187, 120, 0.4)'">
              {{ getMyAttendanceButtonText() }}
            </button>

            <button 
              (click)="myAttendanceStudent = null; myAttendanceStatus = null; myAttendanceMobile = ''"
              style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50px; padding: 16px 20px; cursor: pointer; transition: all 0.3s ease;"
              onmouseover="this.style.background='rgba(255,255,255,0.3)'"
              onmouseout="this.style.background='rgba(255,255,255,0.2)'">
              ğŸ”„
            </button>
          </div>
          
          <div style="text-align: center; margin-top: 16px; font-size: 0.9rem; opacity: 0.8;">
            â° Available hours: 7:00 AM - 7:00 PM
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
