<!-- src/app/pages/library-dashboard/library-dashboard.component.html -->
<div class="dashboard-container">
  <div class="header">
    <h2>ğŸ“Š Library Dashboard</h2>
    <button (click)="loadDashboardData()" class="btn-refresh">ğŸ”„ Refresh</button>
  </div>

  <div *ngIf="errorMessage" class="alert alert-error">{{ errorMessage }}</div>
  <div *ngIf="loading" class="loading">Loading dashboard...</div>

  <div *ngIf="!loading">
    <!-- Summary Cards -->
    <div class="stats-grid">
      <div class="stat-card blue">
        <div class="stat-icon">ğŸª‘</div>
        <div class="stat-content">
          <div class="stat-value">{{ stats.occupiedSeats }}/{{ stats.totalSeats }}</div>
          <div class="stat-label">Occupied Seats</div>
          <div class="stat-subtext">{{ getOccupancyPercentage() }}% Occupancy</div>
        </div>
      </div>

      <div class="stat-card green">
        <div class="stat-icon">ğŸ’°</div>
        <div class="stat-content">
          <div class="stat-value">{{ formatCurrency(stats.totalRevenue) }}</div>
          <div class="stat-label">Total Revenue</div>
          <div class="stat-subtext">This Month</div>
        </div>
      </div>

      <div class="stat-card orange">
        <div class="stat-icon">ğŸ’¸</div>
        <div class="stat-content">
          <div class="stat-value">{{ formatCurrency(stats.totalExpenses) }}</div>
          <div class="stat-label">Total Expenses</div>
          <div class="stat-subtext">This Month</div>
        </div>
      </div>

      <div class="stat-card" [ngClass]="getCashBalanceClass()">
        <div class="stat-icon">ğŸ’µ</div>
        <div class="stat-content">
          <div class="stat-value">{{ formatCurrency(stats.cashBalance) }}</div>
          <div class="stat-label">Cash Balance</div>
          <div class="stat-subtext">Current Available</div>
        </div>
      </div>
    </div>

    <!-- Shift Distribution -->
    <div class="shift-distribution">
      <h3>Shift Distribution</h3>
      <div class="shift-bars">
        <div class="shift-item">
          <span class="shift-label">Full Time</span>
          <div class="shift-bar">
            <div class="shift-fill full-time" [style.width.%]="(stats.fullTimeCount / 36) * 100"></div>
          </div>
          <span class="shift-count">{{ stats.fullTimeCount }}</span>
        </div>
        <div class="shift-item">
          <span class="shift-label">First Half</span>
          <div class="shift-bar">
            <div class="shift-fill first-half" [style.width.%]="(stats.firstHalfCount / 36) * 100"></div>
          </div>
          <span class="shift-count">{{ stats.firstHalfCount }}</span>
        </div>
        <div class="shift-item">
          <span class="shift-label">Second Half</span>
          <div class="shift-bar">
            <div class="shift-fill second-half" [style.width.%]="(stats.secondHalfCount / 36) * 100"></div>
          </div>
          <span class="shift-count">{{ stats.secondHalfCount }}</span>
        </div>
      </div>
    </div>

    <!-- Two Column Layout -->
    <div class="content-grid">
      <!-- Expiring Seats -->
      <div class="panel">
        <div class="panel-header">
          <h3>âš ï¸ Expiring Soon (Next 3 Days)</h3>
          <button *ngIf="expiringSeats.length > 0" (click)="sendReminderToAll()" class="btn-small">
            ğŸ“± Send All Reminders
          </button>
        </div>
        <div class="panel-body">
          <div *ngIf="expiringSeats.length === 0" class="empty-state">
            <div class="empty-icon">âœ…</div>
            <p>No seats expiring soon!</p>
          </div>
          <table *ngIf="expiringSeats.length > 0" class="data-table">
            <thead>
              <tr>
                <th>Seat</th>
                <th>Student</th>
                <th>Mobile</th>
                <th>Shift</th>
                <th>Expiry</th>
                <th>Days Left</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let seat of expiringSeats">
                <td><strong>{{ seat.seat_no }}</strong></td>
                <td>{{ seat.student_name }}</td>
                <td>{{ seat.mobile }}</td>
                <td><span class="badge">{{ seat.shift_type }}</span></td>
                <td>{{ formatDate(seat.expiry_date) }}</td>
                <td>
                  <span class="badge" [ngClass]="'badge-' + getDaysRemainingClass(seat.days_remaining)">
                    {{ seat.days_remaining }} days
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Recent Payments -->
      <div class="panel">
        <div class="panel-header">
          <h3>ğŸ’³ Recent Payments</h3>
        </div>
        <div class="panel-body">
          <div *ngIf="recentPayments.length === 0" class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <p>No payments yet</p>
          </div>
          <table *ngIf="recentPayments.length > 0" class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Student</th>
                <th>Shift</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let payment of recentPayments">
                <td>{{ formatDate(payment.payment_date) }}</td>
                <td>{{ payment.student_name }}</td>
                <td><span class="badge">{{ payment.shift_type }}</span></td>
                <td class="text-success"><strong>{{ formatCurrency(payment.amount_paid) }}</strong></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Recent Expenses -->
    <div class="panel">
      <div class="panel-header">
        <h3>ğŸ’¸ Recent Expenses</h3>
      </div>
      <div class="panel-body">
        <div *ngIf="recentExpenses.length === 0" class="empty-state">
          <div class="empty-icon">ğŸ“­</div>
          <p>No expenses yet</p>
        </div>
        <table *ngIf="recentExpenses.length > 0" class="data-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Category</th>
              <th>Description</th>
              <th>Vendor</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let expense of recentExpenses">
              <td>{{ formatDate(expense.date) }}</td>
              <td><span class="badge badge-secondary">{{ expense.category }}</span></td>
              <td>{{ expense.description || '-' }}</td>
              <td>{{ expense.vendor_name || '-' }}</td>
              <td class="text-danger"><strong>{{ formatCurrency(expense.amount) }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ADMIN ONLY: Attendance Section -->
    <div *ngIf="isAdmin()" class="panel">
      <div class="panel-header">
        <h3>ğŸ“‹ Today's Attendance</h3>
        <button (click)="toggleAttendanceSection()" class="btn-small">
          {{ showAttendanceSection ? 'â–² Hide' : 'â–¼ Show' }}
        </button>
      </div>
      <div *ngIf="showAttendanceSection" class="panel-body">
        <div *ngIf="todayAttendance.length === 0" class="empty-state">
          <div class="empty-icon">ğŸ“­</div>
          <p>No attendance records today</p>
        </div>
        
        <div *ngIf="todayAttendance.length > 0">
          <div class="attendance-summary">
            <span class="badge badge-success">âœ… Present: {{ getAttendanceStats().present }}</span>
            <span class="badge badge-warning">â° Late: {{ getAttendanceStats().late }}</span>
            <span class="badge badge-secondary">ğŸšª Checked Out: {{ getAttendanceStats().checkedOut }}</span>
            <span class="badge badge-primary">ğŸ‘¥ Total: {{ getAttendanceStats().total }}</span>
          </div>

          <table class="data-table">
            <thead>
              <tr>
                <th>Student Name</th>
                <th>Seat No</th>
                <th>Check In</th>
                <th>Check Out</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let attendance of todayAttendance">
                <td><strong>{{ attendance.student_name }}</strong></td>
                <td>{{ attendance.seat_no }}</td>
                <td>{{ attendance.check_in_time }}</td>
                <td>{{ attendance.check_out_time || '-' }}</td>
                <td>
                  <span class="badge" 
                        [ngClass]="attendance.status === 'present' ? 'badge-success' : 'badge-warning'">
                    {{ attendance.status === 'present' ? 'âœ… On Time' : 'â° Late' }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ADMIN ONLY: Detailed Reports Section -->
    <div *ngIf="isAdmin()" class="panel">
      <div class="panel-header">
        <h3>ğŸ“Š Detailed Reports</h3>
        <button (click)="toggleReportsSection()" class="btn-small">
          {{ showReportsSection ? 'â–² Hide' : 'â–¼ Show' }}
        </button>
      </div>
      <div *ngIf="showReportsSection" class="panel-body">
        <!-- Month/Year Selector -->
        <div class="report-filters">
          <label>Month:</label>
          <select [(ngModel)]="selectedMonth" (change)="onMonthYearChange()">
            <option [value]="1">January</option>
            <option [value]="2">February</option>
            <option [value]="3">March</option>
            <option [value]="4">April</option>
            <option [value]="5">May</option>
            <option [value]="6">June</option>
            <option [value]="7">July</option>
            <option [value]="8">August</option>
            <option [value]="9">September</option>
            <option [value]="10">October</option>
            <option [value]="11">November</option>
            <option [value]="12">December</option>
          </select>

          <label>Year:</label>
          <select [(ngModel)]="selectedYear" (change)="onMonthYearChange()">
            <option [value]="2024">2024</option>
            <option [value]="2025">2025</option>
            <option [value]="2026">2026</option>
          </select>
        </div>

        <!-- Monthly Revenue Breakdown -->
        <div class="report-section">
          <div class="report-section-header">
            <h4>ğŸ’° Monthly Revenue Breakdown</h4>
            <button (click)="exportReportToCSV('revenue')" class="btn-small">ğŸ“¥ Export CSV</button>
          </div>
          <table *ngIf="monthlyRevenue.length > 0" class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Registration Fees</th>
                <th>Seat Rentals</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of monthlyRevenue">
                <td>{{ formatDate(row.date) }}</td>
                <td>{{ formatCurrency(row.registration_fees) }}</td>
                <td>{{ formatCurrency(row.seat_rentals) }}</td>
                <td><strong>{{ formatCurrency(row.total) }}</strong></td>
              </tr>
              <tr class="total-row">
                <td><strong>TOTAL</strong></td>
                <td colspan="2"></td>
                <td><strong>{{ formatCurrency(getTotalRevenue()) }}</strong></td>
              </tr>
            </tbody>
          </table>
          <div *ngIf="monthlyRevenue.length === 0" class="empty-state">
            No revenue data for selected period
          </div>
        </div>

        <!-- Student Payment Report -->
        <div class="report-section">
          <div class="report-section-header">
            <h4>ğŸ‘¥ Student-wise Payment Report</h4>
            <button (click)="exportReportToCSV('student-payments')" class="btn-small">ğŸ“¥ Export CSV</button>
          </div>
          <table *ngIf="studentPaymentReport.length > 0" class="data-table">
            <thead>
              <tr>
                <th>Student Name</th>
                <th>Total Paid</th>
                <th>Payment Count</th>
                <th>Last Payment</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of studentPaymentReport">
                <td><strong>{{ row.student_name }}</strong></td>
                <td>{{ formatCurrency(row.total_paid) }}</td>
                <td>{{ row.payment_count }}</td>
                <td>{{ row.last_payment_date ? formatDate(row.last_payment_date) : '-' }}</td>
              </tr>
            </tbody>
          </table>
          <div *ngIf="studentPaymentReport.length === 0" class="empty-state">
            No payment data available
          </div>
        </div>

        <!-- Expense Category Report -->
        <div class="report-section">
          <div class="report-section-header">
            <h4>ğŸ’¸ Expense by Category</h4>
            <button (click)="exportReportToCSV('expenses')" class="btn-small">ğŸ“¥ Export CSV</button>
          </div>
          <table *ngIf="expenseCategoryReport.length > 0" class="data-table">
            <thead>
              <tr>
                <th>Category</th>
                <th>Total Amount</th>
                <th>Transaction Count</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of expenseCategoryReport">
                <td><span class="badge badge-secondary">{{ row.category }}</span></td>
                <td>{{ formatCurrency(row.total) }}</td>
                <td>{{ row.count }}</td>
              </tr>
              <tr class="total-row">
                <td><strong>TOTAL</strong></td>
                <td><strong>{{ formatCurrency(getTotalExpenses()) }}</strong></td>
                <td></td>
              </tr>
            </tbody>
          </table>
          <div *ngIf="expenseCategoryReport.length === 0" class="empty-state">
            No expense data for selected period
          </div>
        </div>

        <!-- Profit & Loss Statement -->
        <div *ngIf="profitLoss" class="report-section">
          <h4>ğŸ“ˆ Profit & Loss Statement</h4>
          <div class="pl-summary">
            <div class="pl-item revenue">
              <span class="pl-label">Total Revenue:</span>
              <span class="pl-value">{{ formatCurrency(profitLoss.revenue) }}</span>
            </div>
            <div class="pl-item expense">
              <span class="pl-label">Total Expenses:</span>
              <span class="pl-value">{{ formatCurrency(profitLoss.expenses) }}</span>
            </div>
            <div class="pl-item profit" [ngClass]="profitLoss.profit >= 0 ? 'positive' : 'negative'">
              <span class="pl-label">Net Profit:</span>
              <span class="pl-value"><strong>{{ formatCurrency(profitLoss.profit) }}</strong></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
