<!-- src/app/pages/library-students/library-students.component.html -->
<div class="students-container">
  <div class="header">
    <h2>ğŸ‘¨â€ğŸ“ Library Students</h2>
    <button (click)="openAddModal()" class="btn btn-primary">â• Add Student</button>
  </div>

  <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="alert alert-error">{{ errorMessage }}</div>

  <!-- Filters -->
  <div class="filters">
    <input 
      type="text" 
      [(ngModel)]="searchTerm" 
      (input)="onSearch()" 
      placeholder="ğŸ” Search by name or mobile..." 
      class="search-input">
    
    <select [(ngModel)]="filterStatus" (change)="onFilterChange()" class="filter-select">
      <option value="all">All Status</option>
      <option value="active">Active</option>
      <option value="inactive">Inactive</option>
      <option value="suspended">Suspended</option>
    </select>

    <button (click)="loadStudents()" class="btn btn-secondary">ğŸ”„ Refresh</button>
  </div>

  <div *ngIf="loading" class="loading">Loading students...</div>

  <!-- Students Material Table -->
  <div *ngIf="!loading && filteredStudents.length > 0" class="table-container mat-elevation-z2">
    <table mat-table [dataSource]="dataSource" matSort class="students-table">
      
      <!-- Photo Column -->
      <ng-container matColumnDef="photo">
        <th mat-header-cell *matHeaderCellDef class="photo-column">Photo</th>
        <td mat-cell *matCellDef="let student">
          <div class="student-photo-small">
            <img *ngIf="student.photo_url" [src]="student.photo_url" alt="Photo">
            <div *ngIf="!student.photo_url" class="no-photo-small">ğŸ“·</div>
          </div>
        </td>
      </ng-container>

      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
        <td mat-cell *matCellDef="let student"><strong>{{ student.name }}</strong></td>
      </ng-container>

      <!-- Mobile Column -->
      <ng-container matColumnDef="mobile">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Mobile</th>
        <td mat-cell *matCellDef="let student">{{ student.mobile }}</td>
      </ng-container>

      <!-- Emergency Contact Column -->
      <ng-container matColumnDef="emergency_contact">
        <th mat-header-cell *matHeaderCellDef>Emergency</th>
        <td mat-cell *matCellDef="let student">
          <div class="emergency-info">
            <div>{{ student.emergency_contact }}</div>
            <small *ngIf="student.emergency_contact_name">{{ student.emergency_contact_name }}</small>
          </div>
        </td>
      </ng-container>

      <!-- Address Column -->
      <ng-container matColumnDef="address">
        <th mat-header-cell *matHeaderCellDef>Address</th>
        <td mat-cell *matCellDef="let student" class="address-cell">{{ student.address }}</td>
      </ng-container>

      <!-- Joining Date Column -->
      <ng-container matColumnDef="joining_date">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Joined</th>
        <td mat-cell *matCellDef="let student">{{ formatDate(student.joining_date || '') }}</td>
      </ng-container>

      <!-- Registration Fee Column -->
      <ng-container matColumnDef="registration_fee_paid">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Reg. Fee</th>
        <td mat-cell *matCellDef="let student">{{ formatCurrency(student.registration_fee_paid || 0) }}</td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
        <td mat-cell *matCellDef="let student">
          <span class="badge" [ngClass]="getStatusBadgeClass(student.status || 'active')">
            {{ student.status }}
          </span>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let student">
          <div class="action-buttons-horizontal">
            <button mat-icon-button 
                    matTooltip="View Profile"
                    color="primary"
                    (click)="openProfileModal(student)">
              ğŸ‘¤
            </button>
            
            <button mat-icon-button 
                    matTooltip="Payment History"
                    color="primary"
                    (click)="openPaymentHistory(student)">
              ğŸ’³
            </button>
            
            <button mat-icon-button 
                    matTooltip="WhatsApp"
                    (click)="sendWhatsApp(student)">
              ğŸ’¬
            </button>
            
            <button mat-icon-button 
                    matTooltip="Edit Student"
                    (click)="openEditModal(student)">
              âœï¸
            </button>
            
            <button mat-icon-button 
                    matTooltip="Delete Student"
                    color="warn"
                    (click)="deleteStudent(student)">
              ğŸ—‘ï¸
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="student-row"></tr>
    </table>
  </div>

  <div *ngIf="!loading && filteredStudents.length === 0" class="empty-state">
    <div class="empty-icon">ğŸ“­</div>
    <p>No students found</p>
    <button (click)="openAddModal()" class="btn btn-primary">Add First Student</button>
  </div>

  <!-- Add Student Modal -->
  <div class="modal-overlay" *ngIf="showAddModal" (click)="closeModal()">
    <div class="modal-content large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>â• Add New Student</h3>
        <button (click)="closeModal()" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label>Full Name <span class="required">*</span></label>
            <input type="text" [(ngModel)]="newStudent.name" class="form-control">
          </div>
          <div class="form-group">
            <label>Mobile <span class="required">*</span></label>
            <input type="tel" [(ngModel)]="newStudent.mobile" class="form-control">
          </div>
          <div class="form-group">
            <label>Emergency Contact</label>
            <input type="tel" [(ngModel)]="newStudent.emergency_contact" class="form-control" placeholder="+91 9876543210">
          </div>
          <div class="form-group">
            <label>Emergency Contact Name</label>
            <input type="text" [(ngModel)]="newStudent.emergency_contact_name" class="form-control">
          </div>
          <div class="form-group full-width">
            <label>Address <span class="required">*</span></label>
            <textarea [(ngModel)]="newStudent.address" class="form-control" rows="2"></textarea>
          </div>
          <div class="form-group full-width">
            <label>Date of Birth</label>
            <div class="date-dropdowns">
              <select [(ngModel)]="dobDay" class="form-control" style="flex: 1;">
                <option value="">Day</option>
                <option *ngFor="let day of days" [value]="day">{{day}}</option>
              </select>
              <select [(ngModel)]="dobMonth" class="form-control" style="flex: 2;">
                <option value="">Month</option>
                <option *ngFor="let month of months" [value]="month.value">{{month.label}}</option>
              </select>
              <select [(ngModel)]="dobYear" class="form-control" style="flex: 1.5;">
                <option value="">Year</option>
                <option *ngFor="let year of dobYears" [value]="year">{{year}}</option>
              </select>
            </div>
          </div>
          <div class="form-group full-width">
            <label>Joining Date <span class="required">*</span></label>
            <div class="date-dropdowns">
              <select [(ngModel)]="joiningDay" class="form-control" style="flex: 1;">
                <option value="">Day</option>
                <option *ngFor="let day of days" [value]="day">{{day}}</option>
              </select>
              <select [(ngModel)]="joiningMonth" class="form-control" style="flex: 2;">
                <option value="">Month</option>
                <option *ngFor="let month of months" [value]="month.value">{{month.label}}</option>
              </select>
              <select [(ngModel)]="joiningYear" class="form-control" style="flex: 1.5;">
                <option value="">Year</option>
                <option *ngFor="let year of joiningYears" [value]="year">{{year}}</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Gender</label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" [(ngModel)]="newStudent.gender" value="Male" name="gender-add">
                Male
              </label>
              <label class="radio-label">
                <input type="radio" [(ngModel)]="newStudent.gender" value="Female" name="gender-add">
                Female
              </label>
              <label class="radio-label">
                <input type="radio" [(ngModel)]="newStudent.gender" value="Other" name="gender-add">
                Other
              </label>
            </div>
          </div>
          <div class="form-group full-width">
            <label>Upload Photo</label>
            <input type="file" accept="image/*" (change)="onPhotoSelect($event)" class="form-control">
            <small class="text-muted">Max 2MB (JPG, PNG)</small>
          </div>
          <div class="form-group">
            <label>Registration Fee</label>
            <input type="number" [(ngModel)]="newStudent.registration_fee_paid" class="form-control">
          </div>
          <div class="form-group">
            <label>Status</label>
            <select [(ngModel)]="newStudent.status" class="form-control">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="suspended">Suspended</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label>Notes</label>
            <textarea [(ngModel)]="newStudent.notes" class="form-control" rows="2"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button (click)="closeModal()" class="btn btn-secondary">Cancel</button>
        <button (click)="submitAddStudent()" [disabled]="uploadingPhoto" class="btn btn-primary">
          {{ uploadingPhoto ? 'Uploading...' : 'ğŸ’¾ Save Student' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Student Modal -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>âœï¸ Edit Student</h3>
        <button (click)="closeModal()" class="close-btn">&times;</button>
      </div>
      <div class="modal-body" *ngIf="selectedStudent">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" [(ngModel)]="selectedStudent.name" class="form-control">
        </div>
        <div class="form-group">
          <label>Mobile</label>
          <input type="tel" [(ngModel)]="selectedStudent.mobile" class="form-control">
        </div>
        <div class="form-group">
          <label>Emergency Contact</label>
          <input type="tel" [(ngModel)]="selectedStudent.emergency_contact" class="form-control">
        </div>
        <div class="form-group">
          <label>Emergency Contact Name</label>
          <input type="text" [(ngModel)]="selectedStudent.emergency_contact_name" class="form-control">
        </div>
        <div class="form-group">
          <label>Address</label>
          <textarea [(ngModel)]="selectedStudent.address" class="form-control" rows="2"></textarea>
        </div>
        <div class="form-group">
          <label>Joining Date</label>
          <input type="date" [(ngModel)]="selectedStudent.joining_date" class="form-control">
        </div>
        <div class="form-group">
          <label>Status</label>
          <select [(ngModel)]="selectedStudent.status" class="form-control">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="suspended">Suspended</option>
          </select>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea [(ngModel)]="selectedStudent.notes" class="form-control" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button (click)="closeModal()" class="btn btn-secondary">Cancel</button>
        <button (click)="submitEditStudent()" class="btn btn-primary">ğŸ’¾ Update</button>
      </div>
    </div>
  </div>

  <!-- Payment History Modal -->
  <div class="modal-overlay" *ngIf="showPaymentHistoryModal" (click)="closeModal()">
    <div class="modal-content large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ğŸ’³ Payment History - {{ selectedStudent?.name }}</h3>
        <button (click)="closeModal()" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div *ngIf="paymentHistory.length === 0" class="empty-state">
          <p>No payment history</p>
        </div>
        <table *ngIf="paymentHistory.length > 0" class="data-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Seat</th>
              <th>Shift</th>
              <th>Amount</th>
              <th>Valid From</th>
              <th>Valid Until</th>
              <th>Mode</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let payment of paymentHistory">
              <td>{{ formatDate(payment.payment_date) }}</td>
              <td>{{ payment.seat_no || '-' }}</td>
              <td><span class="badge">{{ payment.shift_type }}</span></td>
              <td class="text-success"><strong>{{ formatCurrency(payment.amount_paid) }}</strong></td>
              <td>{{ formatDate(payment.valid_from) }}</td>
              <td>{{ formatDate(payment.valid_until) }}</td>
              <td>{{ payment.payment_mode }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Change Seat Modal -->
  <div class="modal-overlay" *ngIf="showChangeSeatModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ğŸ”„ Change Seat</h3>
        <button (click)="closeModal()" class="close-btn">&times;</button>
      </div>
      <div class="modal-body" *ngIf="selectedStudent">
        <div class="change-seat-info">
          <h4>{{ selectedStudent.name }}</h4>
          <p><strong>Current Seat:</strong> {{ currentSeatNo }}</p>
          <p><strong>Shift Type:</strong> 
            <span *ngIf="currentShiftType === 'full_time'">Full Time</span>
            <span *ngIf="currentShiftType === 'first_half'">ğŸŒ… Morning Shift</span>
            <span *ngIf="currentShiftType === 'second_half'">ğŸŒƒ Evening Shift</span>
          </p>
        </div>

        <div class="form-group">
          <label>Select New Seat *</label>
          <div class="available-seats-grid">
            <div *ngFor="let seat of availableSeats"
                 class="seat-option"
                 [class.selected]="newSeatNumber === seat.seat_no"
                 (click)="newSeatNumber = seat.seat_no">
              <div class="seat-option-number">{{ seat.seat_no }}</div>
              <div class="seat-option-status">Available</div>
            </div>
          </div>
          <p *ngIf="availableSeats.length === 0" class="text-muted">No seats available for this shift type</p>
        </div>
      </div>
      <div class="modal-footer">
        <button (click)="closeModal()" class="btn btn-secondary">Cancel</button>
        <button (click)="confirmSeatChange()" [disabled]="!newSeatNumber" class="btn btn-primary">
          ğŸ”„ Confirm Change
        </button>
      </div>
    </div>
  </div>

  <!-- Add Shift Modal -->
  <div class="modal-overlay" *ngIf="showAddShiftModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>â• Add {{ newShiftType === 'first_half' ? 'Morning' : 'Evening' }} Shift</h3>
        <button (click)="closeModal()" class="close-btn">&times;</button>
      </div>
      <div class="modal-body" *ngIf="selectedStudent">
        <div class="change-seat-info">
          <h4>{{ selectedStudent.name }}</h4>
          <p><strong>Adding:</strong> 
            <span *ngIf="newShiftType === 'first_half'">ğŸŒ… Morning Shift (6 AM - 12 PM)</span>
            <span *ngIf="newShiftType === 'second_half'">ğŸŒƒ Evening Shift (12 PM - 6 AM)</span>
          </p>
          <p class="text-muted">Valid for 1 month from today</p>
        </div>

        <div class="form-group">
          <label>Select Seat for New Shift *</label>
          <div class="available-seats-grid">
            <div *ngFor="let seat of availableSeats"
                 class="seat-option"
                 [class.selected]="newSeatNumber === seat.seat_no"
                 (click)="newSeatNumber = seat.seat_no">
              <div class="seat-option-number">{{ seat.seat_no }}</div>
              <div class="seat-option-status">Available</div>
            </div>
          </div>
          <p *ngIf="availableSeats.length === 0" class="text-muted">No seats available for this shift</p>
        </div>
      </div>
      <div class="modal-footer">
        <button (click)="closeModal()" class="btn btn-secondary">Cancel</button>
        <button (click)="confirmAddShift()" [disabled]="!newSeatNumber" class="btn btn-success">
          â• Add Shift
        </button>
      </div>
    </div>
  </div>

  <!-- Student Profile Modal -->
  <div class="modal-overlay" *ngIf="showProfileModal" (click)="closeModal()">
    <div class="modal-content profile-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ğŸ‘¨â€ğŸ“ Student Profile</h3>
        <button (click)="closeModal()" class="close-btn">&times;</button>
      </div>
      
      <div class="modal-body" *ngIf="selectedStudent">
        <div class="profile-layout">
          <div class="profile-photo-section">
            <img *ngIf="selectedStudent.photo_url" [src]="selectedStudent.photo_url" alt="Student Photo" class="profile-photo-large">
            <div *ngIf="!selectedStudent.photo_url" class="no-photo-large">ğŸ“·</div>
          </div>
          
          <div class="profile-info-section">
            <h4 class="profile-name">{{ selectedStudent.name }}</h4>
            
            <div class="info-grid">
              <div class="info-item">
                <strong>Mobile:</strong> {{ selectedStudent.mobile }}
              </div>
              <div class="info-item">
                <strong>Address:</strong> {{ selectedStudent.address }}
              </div>
              <div class="info-item">
                <strong>Emergency Contact:</strong> {{ selectedStudent.emergency_contact }}
              </div>
              <div class="info-item">
                <strong>Emergency Name:</strong> {{ selectedStudent.emergency_contact_name || 'N/A' }}
              </div>
              <div class="info-item">
                <strong>Joining Date:</strong> {{ formatDate(selectedStudent.joining_date || '') }}
              </div>
              <div class="info-item">
                <strong>DOB:</strong> {{ selectedStudent.dob ? formatDate(selectedStudent.dob) : 'N/A' }}
              </div>
              <div class="info-item">
                <strong>Gender:</strong> {{ selectedStudent.gender }}
              </div>
              <div class="info-item">
                <strong>Status:</strong> 
                <span class="badge" [ngClass]="getStatusBadgeClass(selectedStudent.status || 'active')">
                  {{ selectedStudent.status }}
                </span>
              </div>
              <div class="info-item">
                <strong>Registration Fee:</strong> {{ formatCurrency(selectedStudent.registration_fee_paid || 0) }}
              </div>
              <div class="info-item full-width" *ngIf="selectedStudent.notes">
                <strong>Notes:</strong> {{ selectedStudent.notes }}
              </div>
            </div>
          </div>
        </div>
        
        <div class="profile-actions-section">
          <h4>Quick Actions</h4>
          <div class="action-buttons-grid">
            <!-- Row 1: Attendance & Fee -->
            <button class="btn btn-primary action-btn"
                    [class]="getAttendanceButtonClass(selectedStudent.id)"
                    (click)="toggleAttendance(selectedStudent)"
                    [disabled]="isCheckedOut(selectedStudent.id)">
              {{ getAttendanceButtonText(selectedStudent.id) }}
            </button>
            
            <button class="btn btn-success action-btn" (click)="openPayFeeModal(selectedStudent)">
              ğŸ’³ Pay Fee
            </button>
            
            <!-- Row 2: Seat & Edit -->
            <button class="btn btn-info action-btn" (click)="openChangeSeatModal(selectedStudent)">
              ğŸ”„ Change Seat
            </button>
            
            <button class="btn btn-secondary action-btn" (click)="openEditModal(selectedStudent); showProfileModal = false;">
              âœï¸ Edit Details
            </button>
            
            <!-- Row 3: Communications -->
            <button class="btn btn-success action-btn" (click)="sendWhatsAppReminder(selectedStudent)">
              ğŸ’¬ WhatsApp Reminder
            </button>
            
            <button class="btn btn-warning action-btn" (click)="sendEmergencySOS(selectedStudent)">
              ğŸš¨ Emergency SOS
            </button>
            
            <!-- Row 4: History & Release -->
            <button class="btn btn-info action-btn" (click)="openPaymentHistory(selectedStudent); showProfileModal = false;">
              ğŸ“œ Payment History
            </button>
            
            <button class="btn btn-danger action-btn" (click)="releaseSeat(selectedStudent)">
              ğŸšª Release Seat
            </button>
            
            <!-- Row 5: Add Shift (conditional) -->
            <button class="btn btn-primary action-btn add-shift-btn" 
                    (click)="openAddShiftModal(selectedStudent)"
                    *ngIf="canShowAddShiftButton">
              {{ addShiftButtonText }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Actions Bottom Left -->
  <div class="profile-actions" *ngIf="showEditModal && selectedStudent">
    <button (click)="openPaymentHistory(selectedStudent)" class="btn-icon" title="Payment History">ğŸ’³</button>
    <button (click)="sendWhatsApp(selectedStudent)" class="btn-icon" title="WhatsApp">ğŸ’¬</button>
    <button (click)="openEditModal(selectedStudent)" class="btn-icon" title="Edit">âœï¸</button>
    <button (click)="deleteStudent(selectedStudent)" class="btn-icon danger" title="Delete">ğŸ—‘ï¸</button>
  </div>
</div>
