<!-- Comprehensive Reports Dashboard with Dialog-based Actions -->
<app-breadcrumb></app-breadcrumb>
<div class="reports-dashboard">
  
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-left">
      <h1>üìä Reports & Due Management</h1>
      <p>Manage payments, collections, and view comprehensive reports</p>
    </div>
  </div>

  <!-- Messages -->
  <div class="messages" *ngIf="successMessage || errorMessage">
    <div class="success-msg" *ngIf="successMessage">{{ successMessage }}</div>
    <div class="error-msg" *ngIf="errorMessage">{{ errorMessage }}</div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-btn" [class.active]="activeTab === 'workers'" (click)="switchTab('workers')">
      üë∑ Workers / Labor
    </button>
    <button class="tab-btn" [class.active]="activeTab === 'clients'" (click)="switchTab('clients')">
      üë• Clients
    </button>
    <button class="tab-btn" [class.active]="activeTab === 'partners'" (click)="switchTab('partners')">
      ü§ù Partners
    </button>
    <button class="tab-btn" [class.active]="activeTab === 'company'" (click)="switchTab('company')">
      üè¢ Company Overview
    </button>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading data...</p>
  </div>

  <!-- ========== WORKERS TAB ========== -->
  <div class="tab-content" *ngIf="activeTab === 'workers' && !loading">
    <div class="content-header">
      <h2>Workers Outstanding Payment</h2>
      <div class="stats">
        <div class="stat-card">
          <small>Total Outstanding</small>
          <strong>{{ formatCurrency(totalWorkersOutstanding) }}</strong>
        </div>
        <div class="stat-card">
          <small>Total Workers</small>
          <strong>{{ workersWithOutstanding.length }}</strong>
        </div>
      </div>
    </div>

    <div class="data-grid" *ngIf="workersWithOutstanding.length > 0; else noWorkersOutstanding">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Worker Name</th>
            <th>Phone</th>
            <th>Total Earned</th>
            <th>Total Paid</th>
            <th class="text-right">Outstanding</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let worker of workersWithOutstanding; let i = index">
            <td>{{ i + 1 }}</td>
            <td><strong>{{ worker.worker_name }}</strong></td>
            <td>{{ worker.phone || 'N/A' }}</td>
            <td>{{ formatCurrency(worker.total_earned) }}</td>
            <td>{{ formatCurrency(worker.total_paid) }}</td>
            <td class="text-right amount-highlight">{{ formatCurrency(worker.outstanding) }}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-success" (click)="openPayWorkerDialog(worker, 'full')" title="Pay Full">
                  Pay Full
                </button>
                <button class="btn btn-sm btn-primary" (click)="openPayWorkerDialog(worker, 'partial')" title="Pay Partial">
                  Partial
                </button>
                <button class="btn btn-sm btn-info" (click)="openPassbookDialog(worker)" title="View Passbook">
                  Passbook
                </button>
              </div>
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="5" class="text-right"><strong>Total Outstanding:</strong></td>
            <td class="text-right"><strong>{{ formatCurrency(totalWorkersOutstanding) }}</strong></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <ng-template #noWorkersOutstanding>
      <div class="empty-state">
        <span class="empty-icon">‚úÖ</span>
        <h3>No Outstanding Payments</h3>
        <p>All workers have been paid in full!</p>
      </div>
    </ng-template>
  </div>

  <!-- ========== CLIENTS TAB ========== -->
  <div class="tab-content" *ngIf="activeTab === 'clients' && !loading">
    <div class="content-header">
      <h2>Client Outstanding Collections</h2>
      <div class="stats">
        <div class="stat-card">
          <small>Total Outstanding</small>
          <strong>{{ formatCurrency(totalClientsOutstanding) }}</strong>
        </div>
        <div class="stat-card">
          <small>Total Clients</small>
          <strong>{{ clientsWithOutstanding.length }}</strong>
        </div>
      </div>
    </div>

    <div class="data-grid" *ngIf="clientsWithOutstanding.length > 0; else noClientsOutstanding">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Client Name</th>
            <th>Phone</th>
            <th>Total Sales</th>
            <th>Total Paid</th>
            <th class="text-right">Outstanding</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let client of clientsWithOutstanding; let i = index">
            <td>{{ i + 1 }}</td>
            <td><strong>{{ client.client_name }}</strong></td>
            <td>{{ client.phone || 'N/A' }}</td>
            <td>{{ formatCurrency(client.total_sales) }}</td>
            <td>{{ formatCurrency(client.total_paid) }}</td>
            <td class="text-right amount-highlight">{{ formatCurrency(client.outstanding) }}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-success" (click)="openCollectFromClientDialog(client, 'full')" title="Collect Full">
                  Collect Full
                </button>
                <button class="btn btn-sm btn-primary" (click)="openCollectFromClientDialog(client, 'partial')" title="Collect Partial">
                  Partial
                </button>
              </div>
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="5" class="text-right"><strong>Total Outstanding:</strong></td>
            <td class="text-right"><strong>{{ formatCurrency(totalClientsOutstanding) }}</strong></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <ng-template #noClientsOutstanding>
      <div class="empty-state">
        <span class="empty-icon">‚úÖ</span>
        <h3>No Outstanding Collections</h3>
        <p>All clients have paid in full!</p>
      </div>
    </ng-template>
  </div>

  <!-- ========== PARTNERS TAB ========== -->
  <div class="tab-content" *ngIf="activeTab === 'partners' && !loading">
    <div class="content-header">
      <h2>Partners Information</h2>
    </div>

    <div class="data-grid" *ngIf="partnerInfo.length > 0; else noPartners">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Partner Name</th>
            <th>Profit Share</th>
            <th>Wallet Balance</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let partner of partnerInfo; let i = index">
            <td>{{ i + 1 }}</td>
            <td><strong>{{ partner.partner_name }}</strong></td>
            <td>{{ partner.share_percentage }}%</td>
            <td>{{ formatCurrency(partner.wallet_balance || 0) }}</td>
            <td>
              <span class="status-badge active">
                Active
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <ng-template #noPartners>
      <div class="empty-state">
        <span class="empty-icon">ü§ù</span>
        <h3>No Partners</h3>
        <p>No partner records found</p>
      </div>
    </ng-template>
  </div>

  <!-- ========== COMPANY OVERVIEW TAB ========== -->
  <div class="tab-content" *ngIf="activeTab === 'company' && !loading">
    <h2>Company Overview</h2>

    <!-- Summary Cards -->
    <div class="summary-grid">
      <div class="summary-card revenue">
        <div class="card-icon">üí∞</div>
        <div class="card-content">
          <small>Total Revenue</small>
          <strong>{{ formatCurrency(companyStats.totalRevenue) }}</strong>
        </div>
      </div>
      <div class="summary-card expense">
        <div class="card-icon">üí∏</div>
        <div class="card-content">
          <small>Total Expenses</small>
          <strong>{{ formatCurrency(companyStats.totalExpenses) }}</strong>
        </div>
      </div>
      <div class="summary-card profit">
        <div class="card-icon">üìà</div>
        <div class="card-content">
          <small>Net Profit</small>
          <strong>{{ formatCurrency(companyStats.netProfit) }}</strong>
        </div>
      </div>
      <div class="summary-card outstanding">
        <div class="card-icon">üë∑</div>
        <div class="card-content">
          <small>Worker Outstanding</small>
          <strong>{{ formatCurrency(companyStats.totalWorkerOutstanding) }}</strong>
        </div>
      </div>
      <div class="summary-card receivable">
        <div class="card-icon">üë•</div>
        <div class="card-content">
          <small>Client Outstanding</small>
          <strong>{{ formatCurrency(companyStats.totalClientOutstanding) }}</strong>
        </div>
      </div>
      <div class="summary-card stock">
        <div class="card-icon">üì¶</div>
        <div class="card-content">
          <small>Material Stock Value</small>
          <strong>{{ formatCurrency(companyStats.totalMaterialStock) }}</strong>
        </div>
      </div>
      <div class="summary-card inventory">
        <div class="card-icon">üèóÔ∏è</div>
        <div class="card-content">
          <small>Finished Stock Value</small>
          <strong>{{ formatCurrency(companyStats.totalFinishedStock) }}</strong>
        </div>
      </div>
    </div>

    <!-- Detailed Sections -->
    <div class="detail-sections">
      <!-- Material Stock -->
      <div class="detail-card">
        <h3>üì¶ Material Stock</h3>
        <div class="mini-table" *ngIf="materialStock.length > 0">
          <table>
            <thead>
              <tr>
                <th>Material</th>
                <th>Quantity</th>
                <th>Unit</th>
                <th>Avg Rate</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let mat of materialStock">
                <td>{{ mat.material_name }}</td>
                <td>{{ mat.current_stock }}</td>
                <td>{{ mat.unit }}</td>
                <td>{{ formatCurrency(mat.unit_cost || 0) }}</td>
                <td>{{ formatCurrency((mat.current_stock * (mat.unit_cost || 0))) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Finished Goods -->
      <div class="detail-card">
        <h3>üèóÔ∏è Finished Goods Inventory</h3>
        <div class="mini-table" *ngIf="finishedStock.length > 0">
          <table>
            <thead>
              <tr>
                <th>Product</th>
                <th>Variant</th>
                <th>Quantity</th>
                <th>Est. Cost/Unit</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let prod of finishedStock">
                <td>{{ prod.product_name }}</td>
                <td>{{ prod.product_variant || 'Standard' }}</td>
                <td>{{ prod.current_stock }}</td>
                <td>{{ formatCurrency(prod.unit_cost || 0) }}</td>
                <td>{{ formatCurrency((prod.current_stock * (prod.unit_cost || 0))) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ========== PAYMENT DIALOG ========== -->
<div class="modal-overlay" *ngIf="paymentDialog.show" (click)="closePaymentDialog()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <span *ngIf="paymentDialog.type === 'worker'">üí∞ Pay Worker</span>
        <span *ngIf="paymentDialog.type === 'client'">üíµ Collect from Client</span>
      </h3>
      <button class="btn-close" (click)="closePaymentDialog()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="info-row">
        <strong>Name:</strong>
        <span>{{ paymentDialog.workerName || paymentDialog.clientName }}</span>
      </div>
      <div class="info-row">
        <strong>Outstanding Amount:</strong>
        <span class="amount-highlight">{{ formatCurrency(paymentDialog.outstandingAmount || 0) }}</span>
      </div>
      <div class="info-row">
        <strong>Payment Mode:</strong>
        <span class="mode-badge" [class.full]="paymentDialog.mode === 'full'">
          {{ paymentDialog.mode === 'full' ? 'Full Payment' : 'Partial Payment' }}
        </span>
      </div>

      <div class="form-group">
        <label>Payment Amount *</label>
        <input type="number" [(ngModel)]="paymentDialog.paymentAmount" 
               [max]="paymentDialog.outstandingAmount || 0"
               min="0" step="0.01" class="form-control">
      </div>

      <div class="form-group" *ngIf="paymentDialog.type === 'worker'">
        <label>Payment Source *</label>
        <select [(ngModel)]="paymentDialog.paymentSource" class="form-control">
          <option value="company">Company Revenue</option>
          <option value="client_revenue">Client Revenue</option>
        </select>
      </div>

      <div class="form-group" *ngIf="paymentDialog.type === 'client'">
        <label>Collected By *</label>
        <select [(ngModel)]="paymentDialog.collectedBy" class="form-control">
          <option value="firm">Firm Cash</option>
          <option *ngFor="let p of partners" [value]="p.partner_name">{{p.partner_name}}</option>
        </select>
      </div>

      <div class="form-group" *ngIf="paymentDialog.type === 'client' && paymentDialog.collectedBy !== 'firm'">
        <label>Deposited to Firm? *</label>
        <div style="display: flex; gap: 16px; padding: 8px 0;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="depositedToFirm" [value]="true" [(ngModel)]="paymentDialog.depositedToFirm" style="cursor: pointer;">
            <span style="font-weight: 600;">‚úÖ Yes, Deposited</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="depositedToFirm" [value]="false" [(ngModel)]="paymentDialog.depositedToFirm" style="cursor: pointer;">
            <span style="font-weight: 600;">‚è≥ Not Yet</span>
          </label>
        </div>
        <small style="color: #6b7280; font-size: 0.85rem; display: block; margin-top: 4px;">Track if partner has deposited the collected amount to firm account</small>
      </div>

      <div class="form-group">
        <label>Payment Date *</label>
        <input type="date" [(ngModel)]="paymentDialog.paymentDate" class="form-control">
      </div>

      <div class="form-group">
        <label>Notes</label>
        <textarea [(ngModel)]="paymentDialog.notes" rows="3" class="form-control" 
                  placeholder="Optional payment notes..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closePaymentDialog()" [disabled]="saving">
        Cancel
      </button>
      <button class="btn btn-primary" (click)="submitPayment()" [disabled]="saving || paymentDialog.paymentAmount <= 0">
        {{ saving ? 'Processing...' : 'Confirm Payment' }}
      </button>
    </div>
  </div>
</div>

<!-- ========== PASSBOOK DIALOG ========== -->
<div class="modal-overlay" *ngIf="passbookDialog.show" (click)="closePassbookDialog()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>üìñ Worker Passbook - {{ passbookDialog.workerName }}</h3>
      <button class="btn-close" (click)="closePassbookDialog()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="passbook-content" *ngIf="passbookDialog.entries.length > 0; else noEntries">
        <table class="passbook-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Wage Earned</th>
              <th>Paid Initially</th>
              <th>Paid Later</th>
              <th>Outstanding</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let entry of passbookDialog.entries">
              <td>{{ formatDate(entry.work_date) }}</td>
              <td>{{ entry.attendance_type }}</td>
              <td>{{ formatCurrency(entry.wage_earned) }}</td>
              <td>{{ formatCurrency(entry.paid_initially) }}</td>
              <td>{{ formatCurrency(entry.total_paid_later) }}</td>
              <td class="amount-highlight">{{ formatCurrency(entry.current_outstanding) }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="2"><strong>Total:</strong></td>
              <td><strong>{{ formatCurrency(passbookTotalWageEarned) }}</strong></td>
              <td><strong>{{ formatCurrency(passbookTotalPaidInitially) }}</strong></td>
              <td><strong>{{ formatCurrency(passbookTotalPaidLater) }}</strong></td>
              <td><strong>{{ formatCurrency(passbookTotalOutstanding) }}</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>
      <ng-template #noEntries>
        <div class="empty-state">
          <span class="empty-icon">üìñ</span>
          <p>No wage entries found</p>
        </div>
      </ng-template>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closePassbookDialog()">Close</button>
    </div>
  </div>
</div>
